<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>AquaBytes - Water Quality Hub</title>
		<link
			href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
			rel="stylesheet" />
		<link rel="stylesheet" href="style.css" />
	</head>
	<body>
		<!-- Spinner / Loading -->
		<div id="spinnerOverlay">
			<div class="spinner-box">
				<div class="spinner-border text-primary" role="status">
					<span class="visually-hidden">Loading...</span>
				</div>
				<div>Contacting server…</div>
			</div>
		</div>

		<!-- Device Selection Modal -->
		<div class="modal fade" id="deviceModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Select Device</h5>
					</div>
					<div class="modal-body">
						<form id="deviceForm">
							<div class="mb-3">
								<label for="deviceId" class="form-label">Device ID</label>
								<input
									type="text"
									class="form-control"
									id="deviceId"
									placeholder="ESP32_001"
									required />
							</div>
							<button type="submit" class="btn btn-primary w-100">
								Load Data
							</button>
						</form>
					</div>
				</div>
			</div>
		</div>

		<!-- Navbar -->
		<nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm">
			<div class="container">
				<a class="navbar-brand fw-bold" href="/">AquaBytes</a>
				<button
					class="navbar-toggler"
					data-bs-toggle="collapse"
					data-bs-target="#navMenu">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navMenu">
					<ul class="navbar-nav ms-auto">
						<li class="nav-item">
							<a class="nav-link active" href="#">Citizen Tool</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="/stat/">Analytics</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="/resource/">Resources</a>
						</li>
						<li class="nav-item">
							<a class="nav-link" href="/download/">Download</a>
						</li>
					</ul>
				</div>
			</div>
		</nav>

		<!-- Hero Section -->
		<section class="hero">
			<div class="container">
				<div class="hero-card">
					<div class="row align-items-center">
						<!-- WQI -->
						<div class="col-md-4 text-center text-md-start mb-4 mb-md-0">
							<div class="section-title">Water Quality Index</div>
							<div class="wqi" id="wqiVal">—</div>
							<div class="fw-semibold" id="wqiCategory">—</div>
							<div class="small opacity-75 mt-1" id="wqiDevice">—</div>
						</div>

						<!-- Parameters -->
						<div class="col-md-8">
							<div class="row g-4 text-center text-md-start" id="paramList">
								<!-- Parameters populated by JS -->
							</div>
						</div>
					</div>
				</div>
			</div>
		</section>

		<!-- Main Content -->
		<main class="main">
			<div class="container">
				<div class="surface">
					<ul class="nav nav-tabs mb-4">
						<li class="nav-item">
							<button
								class="nav-link active"
								data-bs-toggle="tab"
								data-bs-target="#risks">
								Risks
							</button>
						</li>
						<li class="nav-item">
							<button
								class="nav-link"
								data-bs-toggle="tab"
								data-bs-target="#usage">
								Usage
							</button>
						</li>
						<li class="nav-item">
							<button
								class="nav-link d-flex align-items-center"
								data-bs-toggle="tab"
								data-bs-target="#alerts">
								Alerts
								<span
									class="badge bg-danger ms-2"
									id="alertBadge"
									style="display: none"></span>
							</button>
						</li>
						<li class="nav-item">
							<button
								class="nav-link d-flex align-items-center"
								data-bs-toggle="tab"
								data-bs-target="#recommendations">
								Recommendations
								<span
									class="badge bg-success ms-2"
									id="recBadge"
									style="display: none"></span>
							</button>
						</li>
					</ul>

					<div class="tab-content">
						<!-- Risks -->
						<div class="tab-pane fade show active" id="risks">
							<p>
								<strong>Microbial Risk:</strong>
								<span id="microbialRisk">—</span>
							</p>
							<p>
								<strong>Heavy Metal Risk:</strong>
								<span id="heavyMetalRisk">—</span>
							</p>
						</div>

						<!-- Usage -->
						<div class="tab-pane fade" id="usage">
							<ul class="list-unstyled" id="usageList">
								Nothing to see here.
							</ul>
						</div>

						<!-- Alerts -->
						<div class="tab-pane fade" id="alerts">
							<div id="alertContainer">Nothing to see here.</div>
						</div>

						<!-- Recommendations -->
						<div class="tab-pane fade" id="recommendations">
							<div id="recContainer">Nothing to see here.</div>
						</div>
					</div>
				</div>
			</div>
		</main>

		<footer class="text-center mt-5 py-3">
			<small>&copy; 2025 Universal Rainwater Harvesting Portal</small>
		</footer>

		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
		<script>
			document.addEventListener("DOMContentLoaded", () => {
				const spinner = document.getElementById("spinnerOverlay");
				const deviceModal = new bootstrap.Modal(
					document.getElementById("deviceModal"),
					{ backdrop: "static", keyboard: false }
				);
				deviceModal.show();

				const deviceForm = document.getElementById("deviceForm");
				deviceForm.addEventListener("submit", async (e) => {
					e.preventDefault();
					const deviceId = document.getElementById("deviceId").value.trim();
					if (!deviceId) return;
					spinner.style.display = "flex";
					deviceModal.hide();

					try {
						const res = await fetch(
							`https://evs-aquabytes.onrender.com/api/v1/predict/latest/${deviceId}`,
							{
								method: "POST",
								headers: { accept: "application/json" },
								body: "",
							}
						);
						const data = await res.json();
						populateData(data);
					} catch (err) {
						alert("Error fetching data: " + err.message);
					} finally {
						spinner.style.display = "none";
					}
				});

				function populateData(data) {
					const sensor = data.data.sensor_data;
					const wqi = data.data.wqi;

					document.getElementById("wqiVal").textContent = wqi.wqi;
					document.getElementById("wqiCategory").textContent = wqi.category;
					document.getElementById(
						"wqiDevice"
					).textContent = `${sensor.device_id} · ${sensor.location}`;

					// Parameters
					const params = ["ph", "tds", "turbidity", "do", "temperature"];
					const paramList = document.getElementById("paramList");
					paramList.innerHTML = "";
					params.forEach((p) => {
						const div = document.createElement("div");
						div.className = `col-md-3 param ${
							wqi.sub_indices[p] >= 80
								? "safe"
								: wqi.sub_indices[p] >= 50
								? "warn"
								: "danger"
						}`;
						div.innerHTML = `<div class="param-label">${p.toUpperCase()}</div><div class="param-value">${
							sensor[p]
						}${
							p === "tds"
								? " ppm"
								: p === "turbidity"
								? " NTU"
								: p === "temperature"
								? " °C"
								: " mg/L"
						}</div>`;
						paramList.appendChild(div);
					});

					// Risks
					document.getElementById("microbialRisk").textContent =
						data.data.microbial_risk.level;
					document.getElementById("heavyMetalRisk").textContent =
						data.data.heavy_metal_risk.level;

					// Usage
					const usageList = document.getElementById("usageList");
					usageList.innerHTML = "";
					const usage = data.data.rooftop_harvest.suitable_purposes;
					let usageEmpty = true;
					for (const [k, v] of Object.entries(usage)) {
						const span = document.createElement("strong");
						span.textContent = v ? "Allowed" : "Not suitable";
						span.className = v ? "text-success" : "text-danger";
						const li = document.createElement("li");
						li.textContent = k.charAt(0).toUpperCase() + k.slice(1) + ": ";
						li.appendChild(span);
						usageList.appendChild(li);
						usageEmpty = false;
					}
					if (usageEmpty) usageList.textContent = "Nothing to see here.";

					// Alerts
					const alertContainer = document.getElementById("alertContainer");
					const alertBadge = document.getElementById("alertBadge");
					alertContainer.innerHTML = "";
					if (!data.data.alerts || data.data.alerts.length === 0) {
						alertContainer.textContent = "Nothing to see here.";
						alertBadge.style.display = "none";
					} else {
						data.data.alerts.forEach((a) => {
							const div = document.createElement("div");
							div.className = `alert ${
								a.severity === "high" || a.severity === "critical"
									? "alert-danger"
									: "alert-warning"
							}`;
							div.textContent = a.message;
							alertContainer.appendChild(div);
						});
						alertBadge.innerText = data.data.alerts.length;
						alertBadge.style.display = "inline-block";
					}

					// Recommendations
					const recContainer = document.getElementById("recContainer");
					const recBadge = document.getElementById("recBadge");
					recContainer.innerHTML = "";
					if (
						!data.data.recommendations ||
						data.data.recommendations.length === 0
					) {
						recContainer.textContent = "Nothing to see here.";
						recBadge.style.display = "none";
					} else {
						const ul = document.createElement("ul");
						data.data.recommendations.forEach((r) => {
							const li = document.createElement("li");
							li.textContent = r;
							ul.appendChild(li);
						});
						recContainer.appendChild(ul);
						recBadge.innerText = data.data.recommendations.length;
						recBadge.style.display = "inline-block";
					}
				}
			});
		</script>
	</body>
</html>
